<header class="site-header" role="banner">
  <div class="wrapper">
    {%- assign default_paths = site.pages | map: "path" -%}
    {%- assign page_paths = site.header_pages | default: default_paths -%}
    
    <div class="header-content">
      
      <!-- Logo - LEFT SIDE -->
      <div class="header-brand">
        <a href="{{ "/" | relative_url }}" class="header-brand-link">
          <img src="{{ "/assets/img/budsy-app-icon.png" | relative_url }}" alt="budsyapp" class="header-logo">
        </a>
      </div>

      <!-- Desktop Navigation - CENTER/RIGHT -->
      <nav class="site-nav desktop-nav">
        <div class="nav-links">
          <a class="page-link" href="{{ '/' | relative_url }}">Home</a>
          <a class="page-link" href="{{ '/blog/' | relative_url }}">Blog</a>
          <div class="download-trigger">
            <a class="page-link" href="#downloads" onclick="toggleDownloadMenu(event)">
              Download <span class="dropdown-arrow">â–¼</span>
            </a>
            
            <!-- Download dropdown menu -->
            <div class="download-dropdown" id="download-menu">
              <a href="{{ '/ios-download/' | relative_url }}" class="download-link">
                <span class="platform-icon">ðŸ“±</span> iOS
              </a>
              <a href="#" class="download-link">
                <span class="platform-icon">ðŸ¤–</span> Android <small>(soon)</small>
              </a>
            </div>
          </div>
          <a class="page-link" href="{{ '/terms/' | relative_url }}">Terms</a>
          <a class="page-link" href="{{ '/privacy/' | relative_url }}">Privacy</a>
          
          <!-- Desktop Theme Toggle -->
          <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">ðŸŒ™</span>
          </button>
        </div>
      </nav>

      <!-- Mobile Navigation Controls - RIGHT SIDE -->
      <div class="mobile-nav-wrapper">
        <!-- Mobile Theme Toggle FIRST -->
        <button id="theme-toggle-mobile" class="theme-toggle mobile-theme-toggle" onclick="toggleTheme()">
          <span id="theme-icon-mobile">ðŸŒ™</span>
        </button>
        
        <!-- Mobile Menu SECOND -->
        <nav class="site-nav mobile-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger" class="nav-trigger-label">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="24px" height="18px" class="menu-icon-svg">
                <path d="m18,1.484c0,0.82-0.665,1.484-1.484,1.484h-15.032c-0.819,0-1.484-0.665-1.484-1.484s0.665-1.484,1.484-1.484h15.032c0.819,0,1.484,0.665,1.484,1.484z m0,5.125c0,0.82-0.665,1.484-1.484,1.484h-15.032c-0.819,0-1.484-0.665-1.484-1.484s0.665-1.484,1.484-1.484h15.032c0.819,0,1.484,0.665,1.484,1.484z m0,5.109c0,0.82-0.665,1.484-1.484,1.484h-15.032c-0.819,0-1.484-0.665-1.484-1.484s0.665-1.484,1.484-1.484h15.032c0.819,0,1.484,0.665,1.484,1.484z"/>
              </svg>
            </span>
          </label>

          <!-- Mobile Menu Dropdown -->
          <div class="trigger">
            <a class="mobile-page-link" href="{{ '/' | relative_url }}" data-url="{{ '/' | relative_url }}">Home</a>
            <a class="mobile-page-link" href="{{ '/blog/' | relative_url }}" data-url="{{ '/blog/' | relative_url }}">Blog</a>
            <a class="mobile-page-link" href="{{ '/terms/' | relative_url }}" data-url="{{ '/terms/' | relative_url }}">Terms</a>
            <a class="mobile-page-link" href="{{ '/privacy/' | relative_url }}" data-url="{{ '/privacy/' | relative_url }}">Privacy</a>
            
            <!-- Mobile Download Section -->
            <div class="mobile-download-section">
              <span class="mobile-section-header">Download</span>
              <a class="mobile-page-link mobile-sub-link" href="{{ '/ios-download/' | relative_url }}" data-url="{{ '/ios-download/' | relative_url }}">
                ðŸ“± iOS
              </a>
              <a class="mobile-page-link mobile-sub-link" href="#" data-url="#">
                ðŸ¤– Android <small>(soon)</small>
              </a>
            </div>
          </div>
        </nav>
      </div>
    </div>

    <!-- Launch Status -->
    <div class="launch-status">
      <span class="launch-status-text">ðŸš€ Mississippi Unit Support is LIVE! ðŸš€ </span>
    </div>
  </div>
</header>

<script>
// Theme toggle function
function toggleTheme() {
  const body = document.body;
  const isDark = body.classList.toggle('dark-mode');
  
  // Update toggle button icons
  const icons = document.querySelectorAll('#theme-icon, #theme-icon-mobile');
  icons.forEach(icon => {
    icon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
  });
  
  // Save preference
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

// FIXED: Direct navigation function for mobile links
function navigateToPage(url) {
  // Close the mobile menu first
  const navTrigger = document.getElementById('nav-trigger');
  if (navTrigger) {
    navTrigger.checked = false;
  }
  
  // Navigate to the page
  window.location.href = url;
}

// Download dropdown functionality
function toggleDownloadMenu(event) {
  event.preventDefault();
  const menu = document.getElementById('download-menu');
  menu.classList.toggle('show');
}

// Load saved theme on page load
document.addEventListener('DOMContentLoaded', function() {
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
    document.body.classList.add('dark-mode');
    const icons = document.querySelectorAll('#theme-icon, #theme-icon-mobile');
    icons.forEach(icon => icon.textContent = 'â˜€ï¸');
  }
  
  // FIXED: Enhanced mobile menu link handling
  const mobileLinks = document.querySelectorAll('.mobile-page-link');
  mobileLinks.forEach(link => {
    // Remove any existing event listeners
    link.onclick = null;
    
    // Add click event listener
    link.addEventListener('click', function(e) {
      e.preventDefault(); // Prevent default to handle navigation manually
      e.stopPropagation(); // Stop event bubbling
      
      const url = this.getAttribute('href') || this.getAttribute('data-url');
      
      if (url) {
        console.log('Navigating to:', url); // Debug log
        navigateToPage(url);
      }
    });
    
    // Add touch event for better mobile support
    link.addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const url = this.getAttribute('href') || this.getAttribute('data-url');
      
      if (url) {
        console.log('Touch navigating to:', url); // Debug log
        navigateToPage(url);
      }
    });
  });
});

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const downloadTrigger = document.querySelector('.download-trigger');
  const downloadMenu = document.getElementById('download-menu');
  
  if (downloadTrigger && downloadMenu && 
      !downloadTrigger.contains(event.target) && 
      !downloadMenu.contains(event.target)) {
    downloadMenu.classList.remove('show');
  }
});

// Close mobile menu when clicking outside
document.addEventListener('click', function(event) {
  const navTrigger = document.getElementById('nav-trigger');
  const mobileNav = document.querySelector('.mobile-nav');
  
  if (navTrigger && navTrigger.checked && mobileNav && !mobileNav.contains(event.target)) {
    navTrigger.checked = false;
  }
});

// Quick theme application to prevent flash
(function() {
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
    document.documentElement.classList.add('dark-mode');
    document.body.classList.add('dark-mode');
  }
})();
</script>
